---
title: "4. Calculate bioclimatic variables and SDM"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{4. Calculate bioclimatic variables and SDM}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  eval = FALSE,
  comment = "#>"
)
```

It is standard practice in biogeography studies to derive new variables from existing climatic data, as this makes it easier to interpret the data ecologically. One example of this is the calculation of bioclimate variables. Furthermore, these variables are typically employed as inputs for ecological modelling tools, such as Species Distribution Models (SDMs), which correlate them with species occurrences to estimate potential distribution across an area of interest. In this example, we have calculated a set of bioclimatic variables for the specified study period and used them to calibrate a Species Distribution Model (SDM).

## Dependencies and functions

In this step, we load the necessary packages and our own functions in order to convert the star object to a raster stack and project the resulting model predictions.

```{r}
library(dsclimtools)
library(stars)
library(terra)
library(raster)
library(tidyverse)
library(lubridate)
library(dismo)
library(ggplot2)
library(gganimate)
library(KnowBR)

stars_to_stack <- function(i, data){
  data %>% slice("time", i:(i+11)) %>% 
    rast() %>% stack()
}

model.projection <- function(p, predictors_list, land, model) {
  predictors <- predictors_list[[p]] %>% raster::mask(land)
  prediction <- predict(predictors, model, type = "response")
  prediction
}
```

## Period selection

In this section, we outline the period of interest.

```{r}
start <- -14500
end <- -14400
```

## Extraction of source climatic data

In this step, we load the climatic data for the specified period. The data is transformed into a list using the stars_to_stack function, with each element representing a raster stack of the twelve months in each year.

```{r}
tmax <- dsclimtools::read_dsclim( "X:/Data/dsclim_v1/netcdf", "tasmax", start, end, calendar_dates = TRUE, proxy = FALSE)
tmin <- dsclimtools::read_dsclim( "X:/Data/dsclim_v1/netcdf", "tasmin", start, end, calendar_dates = TRUE, proxy = FALSE) 
t <- dsclimtools::read_dsclim( "X:/Data/dsclim_v1/netcdf", "tas", start, end, calendar_dates = TRUE, proxy = FALSE) 
prec <- dsclimtools::read_dsclim( "X:/Data/dsclim_v1/netcdf", "pr", start, end, calendar_dates = TRUE, proxy = FALSE)

tmax <- lapply(seq(1, 1212, by = 12), FUN = stars_to_stack, tmax)
tmin <- lapply(seq(1, 1212, by = 12), FUN = stars_to_stack, tmin)
t <- lapply(seq(1, 1212, by = 12), FUN = stars_to_stack, t)
prec <- lapply(seq(1, 1212, by = 12), FUN = stars_to_stack, prec)

```

![Figure 1. Maximun Temperature](images/tmax.png){width="600"}

## Bioclimatic variables calculation

We have now calculated the 19 bioclimatic variables for the specified period of interest. The data is stored as a list, with each element representing a raster stack of the 19 bioclimatic variables.

```{r}
bio_list <- mapply(dismo::biovars, prec, tmin, tmax, SIMPLIFY = FALSE)
```

## SDM data preparation

We have prepared the presence and absence data in order to run an example of a species distribution model. The environmental values of the current bioclimatic variables were extracted in the same way as previously described.

```{r}
data("Beetles")

presences <- Beetles %>%
  as.data.frame() %>%
  filter(Species =="Bubas bison") %>% 
  select(Longitude, Latitude)

set.seed(1)

Present_bioclim <- system.file("extdata", "1140_bio.tif", package = "dsclimtools") %>% stack()
topo14_mask <- system.file("extdata", "topo14_mask.tif", package = "dsclimtools") %>% raster()

absences <- randomPoints(topo14_mask, 400, presences)

presvals <- raster::extract(Present_bioclim, presences, na.rm = TRUE)
presvals <-  presvals[!rowSums(is.na(presvals)),]

absvals <- raster::extract(Present_bioclim, absences, na.rm = TRUE)
absvals <-  absvals[!rowSums(is.na(absvals)),]

pb <- c(rep(1, nrow(presvals)), rep(0, nrow(absvals)))
sdmdata <- data.frame(cbind(pb, rbind(presvals, absvals)))
```

## GLM calibration and projection

We calibrated a Generalized Linear Model for our presence/absence dataset. Furthermore, we projected the model over the selected period to demonstrate the value of our dataset in biogeographical history studies.

```{r}
model <-  glm(pb ~ bio1 + bio2 + bio3 + bio4 + bio5 + bio6 + bio7 + 
                bio8 + bio9 + bio10 + bio11 + bio12 + bio13 + bio14 +
                bio15 + bio16 + bio17 + bio18 + bio19, data=sdmdata, family = "binomial")

pred_data <- lapply(seq(1,101), FUN = model.projection, bio_list, topo14_mask, model)
names(pred_data) <- paste0(-14500:-14400)
pred_data <- lapply(pred_data, FUN = as.data.frame, xy = TRUE, na.rm = TRUE) %>% 
  reshape2::melt(id.vars = c("x", "y", "layer")) %>% 
  mutate(year = as.numeric(L1)) 
```

## Graphical animation

We have also presented a graphical representation of the fluctuations in the potential distribution of the species over the selected period.

```{r}
pred_data$L1 <- pred_data$L1 %>% as.numeric %>% as.factor

years_list <- seq(-14500, -14400, by = 1)

levels(pred_data$year) <- unlist(lapply(years_list, FUN=function(x)last(x)))
pred_data$year <- pred_data$year %>% as.character %>% as.numeric

gg <- ggplot(
  pred_data, 
  aes(x = x, y = y, fill = layer)
) +
  geom_raster() +
  scale_fill_viridis_c() +
  labs(title = "Year: {current_frame}") +
  theme_minimal() + theme(axis.title.x = element_blank(), axis.title.y = element_blank()) 

options(gganimate.dev_args = list(width = 600, height = 400))
gganim <- gg + transition_manual(year)

animate(gganim, duration = 60, width = 600, height = 400, renderer = gifski_renderer())
```

![Figure 2. SDM Animation](figures/a4/timeseries.gif)
